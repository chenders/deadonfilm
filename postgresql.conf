# =============================================================================
# PostgreSQL 16 Configuration for Shared Server
# Server: 30GB RAM, 10 cores, shared with app + 2 GitHub runners
# =============================================================================

# -----------------------------------------------------------------------------
# Memory (conservative for shared server - runners need headroom)
# -----------------------------------------------------------------------------
shared_buffers = 4GB              # ~13% of RAM (conservative for shared)
effective_cache_size = 12GB       # Planner hint - OS caches too
work_mem = 32MB                   # Per-sort/hash - conservative for shared load
maintenance_work_mem = 512MB      # VACUUM, CREATE INDEX
huge_pages = try

# -----------------------------------------------------------------------------
# Query Planning (SSD optimized)
# -----------------------------------------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200
seq_page_cost = 1.0

# -----------------------------------------------------------------------------
# Parallelism (leave cores for app + runners)
# -----------------------------------------------------------------------------
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# -----------------------------------------------------------------------------
# WAL / Checkpoints
# -----------------------------------------------------------------------------
wal_buffers = 64MB
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# -----------------------------------------------------------------------------
# Connections
# -----------------------------------------------------------------------------
listen_addresses = '*'            # Allow connections from Docker network
max_connections = 40              # Pool max=20 + headroom for maintenance

# -----------------------------------------------------------------------------
# Logging (comprehensive monitoring for New Relic)
# -----------------------------------------------------------------------------
# Enable log collector to write logs to files
logging_collector = on
log_directory = '/var/log/postgresql-docker'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                 # Rotate daily
log_rotation_size = 100MB             # Or when file reaches 100MB
log_truncate_on_rotation = off        # Keep old log files

# Log format and metadata
log_line_prefix = '%t [%p] %u@%d %h '  # timestamp [pid] user@database host
log_timezone = 'UTC'

# Query logging
log_min_duration_statement = 500      # Log queries taking >500ms (slow queries)
log_statement = 'ddl'                 # Log all DDL (CREATE, ALTER, DROP)
log_duration = off                    # Duration automatically included in message body when query exceeds threshold

# Connection logging (useful for New Relic connection tracking)
log_connections = on
log_disconnections = on

# Lock and checkpoint logging
log_checkpoints = on
log_lock_waits = on                   # Log when query waits for lock
log_recovery_conflict_waits = on      # Log replica recovery conflicts

# Autovacuum logging (performance tuning)
log_autovacuum_min_duration = 1000    # Log autovacuum runs taking >1s

# Temp file logging (queries spilling to disk - performance issue)
log_temp_files = 10MB                 # Log temp file usage >10MB

# Error severity
log_min_messages = warning            # Log warnings and above
log_min_error_statement = panic       # Only log full SQL for catastrophic errors to reduce sensitive data in logs

# -----------------------------------------------------------------------------
# New Relic Monitoring Extensions
# -----------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements,pg_wait_sampling,pg_stat_monitor'

# pg_stat_statements configuration
pg_stat_statements.max = 10000    # Maximum number of statements tracked
pg_stat_statements.track = all    # Track all statements (queries + utility commands)
pg_stat_statements.save = on      # Save statistics across server restarts

# pg_wait_sampling configuration (default values work well)
# Tracks wait events for advanced performance analysis

# pg_stat_monitor configuration (default values work well)
# Enhanced query performance statistics
