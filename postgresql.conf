# =============================================================================
# PostgreSQL 16 Configuration for Shared Server
# Server: 30GB RAM, 10 cores, shared with app + 2 GitHub runners
# =============================================================================

# -----------------------------------------------------------------------------
# Memory (conservative for shared server - runners need headroom)
# -----------------------------------------------------------------------------
shared_buffers = 4GB              # ~13% of RAM (conservative for shared)
effective_cache_size = 12GB       # Planner hint - OS caches too
work_mem = 32MB                   # Per-sort/hash - conservative for shared load
maintenance_work_mem = 512MB      # VACUUM, CREATE INDEX
huge_pages = try

# -----------------------------------------------------------------------------
# Query Planning (SSD optimized)
# -----------------------------------------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200
seq_page_cost = 1.0

# -----------------------------------------------------------------------------
# Parallelism (leave cores for app + runners)
# -----------------------------------------------------------------------------
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# -----------------------------------------------------------------------------
# WAL / Checkpoints
# -----------------------------------------------------------------------------
wal_buffers = 64MB
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# -----------------------------------------------------------------------------
# Connections
# -----------------------------------------------------------------------------
listen_addresses = '*'            # Allow connections from Docker network
max_connections = 40              # Pool max=20 + headroom for maintenance

# -----------------------------------------------------------------------------
# Logging (find slow queries)
# -----------------------------------------------------------------------------
log_min_duration_statement = 500
log_checkpoints = on
log_lock_waits = on

# -----------------------------------------------------------------------------
# New Relic Monitoring Extensions
# -----------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements,pg_wait_sampling,pg_stat_monitor'

# pg_stat_statements configuration
pg_stat_statements.max = 10000    # Maximum number of statements tracked
pg_stat_statements.track = all    # Track all statements (queries + utility commands)
pg_stat_statements.save = on      # Save statistics across server restarts

# pg_wait_sampling configuration (default values work well)
# Tracks wait events for advanced performance analysis

# pg_stat_monitor configuration (default values work well)
# Enhanced query performance statistics
