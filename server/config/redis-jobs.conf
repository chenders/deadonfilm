# Redis Configuration for Job Queue System
# Optimized for durability and job persistence

# ============================================================
# PERSISTENCE CONFIGURATION
# ============================================================

# Enable AOF (Append Only File) for durability
# All write operations are logged to a file
appendonly yes

# Fsync every second - good balance of durability and performance
# Potential data loss: ~1 second of jobs in worst-case scenario
# Options: always (slowest, safest), everysec (balanced), no (fastest, least safe)
appendfsync everysec

# AOF file rewrite configuration
# Automatically rewrite the AOF file when it grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Enable RDB snapshots as backup
# Format: save <seconds> <changes>
# After 900 sec (15 min) if at least 1 key changed
save 900 1
# After 300 sec (5 min) if at least 10 keys changed
save 300 10
# After 60 sec if at least 10000 keys changed
save 60 10000

# RDB file location (inside container)
dir /data
dbfilename dump.rdb

# ============================================================
# MEMORY MANAGEMENT
# ============================================================

# Maximum memory limit
maxmemory 512mb

# Eviction policy when maxmemory is reached
# noeviction: return errors when memory limit is reached (jobs must be durable)
# Don't evict keys - fail writes if full (jobs cannot be lost)
maxmemory-policy noeviction

# ============================================================
# SECURITY
# ============================================================

# Require authentication
# Set a strong password via environment variable REDIS_JOBS_PASSWORD
# Example: requirepass your_strong_password_here
# NOTE: Uncomment and set in production, or use ACL for more granular control

# ACL (Access Control List) - Recommended for production
# Create a dedicated user for BullMQ with minimal required permissions
# Example ACL file: /etc/redis/users.acl
# aclfile /etc/redis/users.acl

# Enable TLS/SSL for encrypted connections (production)
# port 0  # Disable unencrypted port
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# Only bind to localhost by default (override via docker-compose network)
# bind 127.0.0.1
# protected-mode yes

# ============================================================
# PERFORMANCE TUNING
# ============================================================

# TCP backlog - number of pending connections queue
tcp-backlog 511

# Timeout - close connection after client is idle for N seconds (0 = disabled)
timeout 0

# TCP keepalive
tcp-keepalive 300

# Slow log - log queries slower than N microseconds
slowlog-log-slower-than 10000
slowlog-max-len 128

# ============================================================
# BullMQ-SPECIFIC OPTIMIZATIONS
# ============================================================

# Disable RDB compression to reduce CPU usage during snapshots
# Job data is already compressed by BullMQ if needed
rdbcompression no

# LFU eviction precision (not used with noeviction, but good default)
lfu-log-factor 10
lfu-decay-time 1

# ============================================================
# LOGGING
# ============================================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (Docker captures this)
logfile ""
